# ğŸš€ AI Chat ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰

> Google Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’è¤‡æ•°ã®æ–¹æ³•ã§è§£èª¬ã—ã¾ã™

## å‰ææ¡ä»¶

1. **Google Cloud SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   # macOSã®å ´åˆ
   brew install google-cloud-sdk
   # ã¾ãŸã¯ https://cloud.google.com/sdk/docs/install ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   ```

2. **èªè¨¼ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š**
   ```bash
   gcloud auth login
   gcloud config set project ai-chat-481005
   ```

3. **Anthropic APIã‚­ãƒ¼ã®æº–å‚™**
   - https://console.anthropic.com/ ã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### æ–¹æ³•1: GitHub Actionsï¼ˆæ¨å¥¨ãƒ»CI/CDï¼‰

GitHubã«pushã™ã‚‹ã ã‘ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

#### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

**è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰:**
```bash
bash scripts/setup-workload-identity.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š
- Workload Identity Federationã®è¨­å®š
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã¨æ¨©é™ä»˜ä¸
- å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã®æ¨©é™è¨­å®š

**GitHub Secretsã®è¨­å®š:**
ãƒªãƒã‚¸ãƒˆãƒªã® **Settings** > **Secrets and variables** > **Actions** ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š
- `ANTHROPIC_API_KEY`: Anthropic APIã‚­ãƒ¼

#### ãƒ‡ãƒ—ãƒ­ã‚¤

`main`ãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚ã¾ãŸã¯ã€GitHub Actionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã§ã™ã€‚

---

### æ–¹æ³•2: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
./deploy-simple.sh
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦ANTHROPIC_API_KEYã‚’å…¥åŠ›
```

---

### æ–¹æ³•3: Makefileã‚’ä½¿ç”¨

```bash
export ANTHROPIC_API_KEY=your-api-key-here
make deploy-gcp PROJECT_ID=ai-chat-481005
```

---

### æ–¹æ³•4: æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–
gcloud services enable cloudbuild.googleapis.com run.googleapis.com

# ã‚½ãƒ¼ã‚¹ã‹ã‚‰ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy ai-chat \
  --source . \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --memory 512Mi \
  --cpu 1 \
  --set-env-vars "ANTHROPIC_API_KEY=your-api-key-here"
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª

### ã‚µãƒ¼ãƒ“ã‚¹URLã®å–å¾—
```bash
gcloud run services describe ai-chat \
  --region asia-northeast1 \
  --format 'value(status.url)'
```

### ãƒ­ã‚°ã®ç¢ºèª
```bash
gcloud logs read --service ai-chat --region asia-northeast1 --limit 50
```

### Cloud Runã‚³ãƒ³ã‚½ãƒ¼ãƒ«
https://console.cloud.google.com/run?project=ai-chat-481005

---

## ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°

```bash
gcloud run services update ai-chat \
  --region asia-northeast1 \
  --set-env-vars "ANTHROPIC_API_KEY=new-api-key"
```

---

## Secret Managerã‚’ä½¿ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰

### 1. Secretã‚’ä½œæˆ
```bash
echo -n "your-api-key" | gcloud secrets create anthropic-api-key --data-file=-
```

### 2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¨©é™ã‚’ä»˜ä¸
```bash
PROJECT_NUMBER=$(gcloud projects describe ai-chat-481005 --format="value(projectNumber)")
gcloud secrets add-iam-policy-binding anthropic-api-key \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### 3. Secretã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
gcloud run deploy ai-chat \
  --region asia-northeast1 \
  --set-secrets "ANTHROPIC_API_KEY=anthropic-api-key:latest"
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Artifact Registryæ¨©é™ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼:**
```
ERROR: denied: Permission "artifactregistry.repositories.uploadArtifacts" denied
```

**åŸå› :**
`gcloud run deploy --source`ãŒä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Artifact Registryã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚

**è§£æ±ºæ–¹æ³•:**

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä¸€æ‹¬è¨­å®šã§ãã¾ã™ï¼š

```bash
#!/bin/bash
PROJECT_ID="ai-chat-481005"
PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
REGION="asia-northeast1"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
  --role="roles/editor"

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"

# ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™ï¼ˆai-chatã¨cloud-run-source-deployã®ä¸¡æ–¹ï¼‰
for REPO in ai-chat cloud-run-source-deploy; do
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
    --role="roles/artifactregistry.writer" \
    --project=${PROJECT_ID}
  
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
    --role="roles/artifactregistry.writer" \
    --project=${PROJECT_ID}
  
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
    --role="roles/artifactregistry.writer" \
    --project=${PROJECT_ID}
done

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå€Ÿç”¨æ¨©é™
gcloud iam service-accounts add-iam-policy-binding ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser" \
  --project=${PROJECT_ID}

gcloud iam service-accounts add-iam-policy-binding ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser" \
  --project=${PROJECT_ID}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã¨ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®ä¸¡æ–¹ã«æ¨©é™ãŒå¿…è¦
- `gcloud run deploy --source`ã¯Compute Engineãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨
- æ¨©é™ã®åæ˜ ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹

---

### Cloud Storageãƒã‚±ãƒƒãƒˆæ¨©é™ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼:**
```
ERROR: does not have storage.buckets.get access to the Google Cloud Storage bucket
```

**è§£æ±ºæ–¹æ³•:**

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™
gcloud projects add-iam-policy-binding ai-chat-481005 \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/storage.admin"

# ãƒã‚±ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™ï¼ˆãƒã‚±ãƒƒãƒˆãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼‰
BUCKET_NAME="run-sources-ai-chat-481005-asia-northeast1"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_NAME} \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/storage.admin" \
  --project=ai-chat-481005
```

---

### ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª

```bash
# æœ€æ–°ã®ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª
BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)" --project=ai-chat-481005)
gcloud builds log ${BUILD_ID} --project=ai-chat-481005 | tail -100
```

---

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
gcloud run services describe ai-chat --region asia-northeast1

# ãƒ­ã‚°ã‚’ç¢ºèª
gcloud logs read --service ai-chat --region asia-northeast1 --limit 50
```

---

## ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### Cloud Runæ–™é‡‘ï¼ˆ2025å¹´ï¼‰
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: æœ€åˆã®200ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆã¯ç„¡æ–™
- **CPU**: $0.00002400/vCPUç§’
- **ãƒ¡ãƒ¢ãƒª**: $0.00000250/GiBç§’

### æœˆé–“ã‚³ã‚¹ãƒˆè©¦ç®—ï¼ˆæƒ³å®šï¼š1æ—¥100ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: 3,000/æœˆ â†’ **$0**ï¼ˆç„¡æ–™æ å†…ï¼‰
- CPUãƒ»ãƒ¡ãƒ¢ãƒª: 1åˆ†/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ **ç´„$2-5/æœˆ**

**åˆè¨ˆ: ç´„$2-5/æœˆ**

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š
2. Cloud CDNã®æœ‰åŠ¹åŒ–
3. Cloud Armorã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
4. Cloud Monitoringã§ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
