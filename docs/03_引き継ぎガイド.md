    # ğŸ“‹ AI Chat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¼•ãç¶™ãã‚¬ã‚¤ãƒ‰

> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ä½“åƒãƒ»è¨­å®šãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AI Chat
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID**: `ai-chat-481005`
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·**: `547627011742`
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: `asia-northeast1` (æ±äº¬)
- **ã‚µãƒ¼ãƒ“ã‚¹å**: `ai-chat`
- **GitHubãƒªãƒã‚¸ãƒˆãƒª**: `Yoshihiro-Kameoka/ai-chat`

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js 15 (App Router) + React 19 + TailwindCSS
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Next.js + Hono
- **ORM**: Prisma.js
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: MongoDB
- **AIãƒ¢ãƒ‡ãƒ«**: Claude-3-sonnet (Anthropic)
- **ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ**: Google Cloud Run

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼
```
GitHub (mainãƒ–ãƒ©ãƒ³ãƒ)
  â†“
GitHub Actions (è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼)
  â†“
Workload Identity Federation (èªè¨¼)
  â†“
Google Cloud Build (Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰)
  â†“
Artifact Registry (ã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜)
  â†“
Cloud Run (ãƒ‡ãƒ—ãƒ­ã‚¤)
```

## ğŸ” èªè¨¼ã¨æ¨©é™è¨­å®š

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

#### 1. Compute Engineãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: `547627011742-compute@developer.gserviceaccount.com`
- **ç”¨é€”**: `gcloud run deploy --source`ãŒå†…éƒ¨çš„ã«ä½¿ç”¨
- **æ¨©é™**:
  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«: `roles/artifactregistry.admin`, `roles/artifactregistry.writer`, `roles/run.admin`, `roles/storage.admin`
  - ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ« (`ai-chat`): `roles/artifactregistry.admin`, `roles/artifactregistry.writer`
  - ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ« (`cloud-run-source-deploy`): `roles/artifactregistry.admin`, `roles/artifactregistry.writer`

#### 2. Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: `547627011742@cloudbuild.gserviceaccount.com`
- **ç”¨é€”**: Cloud Buildã®ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
- **æ¨©é™**:
  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«: `roles/artifactregistry.writer`, `roles/cloudbuild.builds.builder`, `roles/run.admin`, `roles/storage.admin`
  - ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ« (`ai-chat`): `roles/artifactregistry.admin`, `roles/artifactregistry.writer`

#### 3. Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: `service-547627011742@gcp-sa-cloudbuild.iam.gserviceaccount.com`
- **ç”¨é€”**: Cloud Buildã®å†…éƒ¨æ“ä½œ
- **æ¨©é™**:
  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«: `roles/artifactregistry.writer`, `roles/cloudbuild.serviceAgent`, `roles/editor`
  - ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«: `roles/artifactregistry.writer`

#### 4. GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: `github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com`
- **ç”¨é€”**: GitHub Actionsã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
- **æ¨©é™**:
  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«: `roles/artifactregistry.writer`, `roles/cloudbuild.builds.editor`, `roles/iam.serviceAccountUser`, `roles/run.admin`, `roles/serviceusage.serviceUsageAdmin`, `roles/storage.admin`
  - ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ« (`ai-chat`): `roles/artifactregistry.writer`
  - ãƒã‚±ãƒƒãƒˆãƒ¬ãƒ™ãƒ« (`run-sources-ai-chat-481005-asia-northeast1`): `roles/storage.admin`, `roles/storage.objectAdmin`, `roles/storage.legacyBucketReader`

### Workload Identity Federation

- **Poolå**: `github-actions-pool`
- **Providerå**: `github-actions-provider`
- **ãƒªãƒã‚¸ãƒˆãƒª**: `Yoshihiro-Kameoka/ai-chat`
- **è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `scripts/setup-workload-identity.sh`

## ğŸš€ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. å‰ææ¡ä»¶ã®ç¢ºèª

```bash
# Google Cloud SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
gcloud --version

# èªè¨¼ç¢ºèª
gcloud auth login
gcloud config set project ai-chat-481005
```

### 2. å¿…è¦ãªAPIã®æœ‰åŠ¹åŒ–

```bash
gcloud services enable cloudbuild.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable artifactregistry.googleapis.com
```

### 3. Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆ

```bash
# ai-chatãƒªãƒã‚¸ãƒˆãƒªï¼ˆæ˜ç¤ºçš„ã«ä½œæˆã™ã‚‹å ´åˆï¼‰
gcloud artifacts repositories create ai-chat \
  --repository-format=docker \
  --location=asia-northeast1 \
  --description="Docker repository for AI Chat" \
  --project=ai-chat-481005

# cloud-run-source-deployã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã‚‹
```

### 4. æ¨©é™ã®ä¸€æ‹¬è¨­å®š

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å¿…è¦ãªæ¨©é™ã‚’ä¸€æ‹¬è¨­å®šã§ãã¾ã™ï¼š

```bash
#!/bin/bash
PROJECT_ID="ai-chat-481005"
PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
REGION="asia-northeast1"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™
echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™ã‚’è¨­å®šä¸­..."
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/artifactregistry.admin" \
  --condition=None

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/artifactregistry.writer" \
  --condition=None

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/run.admin" \
  --condition=None

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/storage.admin" \
  --condition=None

# Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/artifactregistry.writer" \
  --condition=None

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/run.admin" \
  --condition=None

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/storage.admin" \
  --condition=None

# Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
  --role="roles/editor" \
  --condition=None

# ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™
echo "ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™ã‚’è¨­å®šä¸­..."
for REPO in ai-chat cloud-run-source-deploy; do
  echo "ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
  
  # Compute Engineã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
    --role="roles/artifactregistry.admin" \
    --project=${PROJECT_ID}
  
  # Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
    --role="roles/artifactregistry.admin" \
    --project=${PROJECT_ID}
  
  # Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
  gcloud artifacts repositories add-iam-policy-binding ${REPO} \
    --location=${REGION} \
    --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
    --role="roles/artifactregistry.writer" \
    --project=${PROJECT_ID}
done

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå€Ÿç”¨æ¨©é™
echo "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå€Ÿç”¨æ¨©é™ã‚’è¨­å®šä¸­..."
gcloud iam service-accounts add-iam-policy-binding ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser" \
  --project=${PROJECT_ID}

gcloud iam service-accounts add-iam-policy-binding ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-cloudbuild.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser" \
  --project=${PROJECT_ID}

echo "âœ… æ¨©é™è¨­å®šå®Œäº†"
```

### 5. GitHub Actionsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# Workload Identity Federationã®è¨­å®š
bash scripts/setup-workload-identity.sh
```

**GitHub Secretsã®è¨­å®š:**
ãƒªãƒã‚¸ãƒˆãƒªã® **Settings** > **Secrets and variables** > **Actions** ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š
- `ANTHROPIC_API_KEY`: Anthropic APIã‚­ãƒ¼

## ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### æ–¹æ³•1: GitHub Actionsï¼ˆæ¨å¥¨ï¼‰

`main`ãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

```bash
git add .
git commit -m "Your commit message"
git push origin main
```

ã¾ãŸã¯ã€GitHub Actionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã§ã™ã€‚

### æ–¹æ³•2: ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export ANTHROPIC_API_KEY=your-api-key-here

# ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy ai-chat \
  --source . \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --memory 512Mi \
  --cpu 1 \
  --max-instances 10 \
  --min-instances 0 \
  --set-env-vars "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}" \
  --project=ai-chat-481005
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: Artifact Registryæ¨©é™ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
denied: Permission "artifactregistry.repositories.uploadArtifacts" denied on resource "projects/ai-chat-481005/locations/asia-northeast1/repositories/ai-chat"
```

**åŸå› :**
- `gcloud run deploy --source`ãŒä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Artifact Registryã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒä¸è¶³
- é€šå¸¸ã€Compute Engineãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ`PROJECT_NUMBER-compute@developer.gserviceaccount.com`ï¼‰ãŒä½¿ç”¨ã•ã‚Œã‚‹

**è§£æ±ºæ–¹æ³•:**
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã¨ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®ä¸¡æ–¹ã«æ¨©é™ã‚’ä»˜ä¸
2. ç‰¹ã«`roles/artifactregistry.admin`ã‚’ä»˜ä¸ï¼ˆ`roles/artifactregistry.writer`ã ã‘ã§ã¯ä¸ååˆ†ãªå ´åˆãŒã‚ã‚‹ï¼‰
3. IAMãƒãƒªã‚·ãƒ¼ã®åæ˜ ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹ï¼ˆæœ€å¤§10-15åˆ†ï¼‰

**ç¢ºèªã‚³ãƒãƒ³ãƒ‰:**
```bash
PROJECT_NUMBER=$(gcloud projects describe ai-chat-481005 --format="value(projectNumber)")

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™ç¢ºèª
gcloud projects get-iam-policy ai-chat-481005 \
  --flatten="bindings[].members" \
  --format="table(bindings.role)" \
  --filter="bindings.members:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com AND bindings.role:roles/artifactregistry*"

# ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™ç¢ºèª
gcloud artifacts repositories get-iam-policy ai-chat \
  --location=asia-northeast1 \
  --project=ai-chat-481005
```

### ã‚¨ãƒ©ãƒ¼2: Cloud Storageãƒã‚±ãƒƒãƒˆæ¨©é™ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ERROR: does not have storage.buckets.get access to the Google Cloud Storage bucket
```

**åŸå› :**
- GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Cloud Storageãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒä¸è¶³

**è§£æ±ºæ–¹æ³•:**
```bash
BUCKET_NAME="run-sources-ai-chat-481005-asia-northeast1"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«
gcloud projects add-iam-policy-binding ai-chat-481005 \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/storage.admin"

# ãƒã‚±ãƒƒãƒˆãƒ¬ãƒ™ãƒ«
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_NAME} \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/storage.admin" \
  --project=ai-chat-481005
```

### ã‚¨ãƒ©ãƒ¼3: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ERROR: Key creation is not allowed on this service account.
```

**åŸå› :**
- çµ„ç¹”ãƒãƒªã‚·ãƒ¼ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ä½œæˆãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
- Workload Identity Federationã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
- `scripts/setup-workload-identity.sh`ã‚’å®Ÿè¡Œ

### ã‚¨ãƒ©ãƒ¼4: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª

```bash
# æœ€æ–°ã®ãƒ“ãƒ«ãƒ‰IDã‚’å–å¾—
BUILD_ID=$(gcloud builds list --project=ai-chat-481005 --limit=1 --format="value(id)")

# ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª
gcloud builds log ${BUILD_ID} --project=ai-chat-481005 | tail -100

# ãƒ“ãƒ«ãƒ‰ã®è©³ç´°ã‚’ç¢ºèª
gcloud builds describe ${BUILD_ID} --project=ai-chat-481005
```

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

### 1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®é¸æŠ

- `gcloud run deploy --source`ã¯`--build-service-account`ãƒ•ãƒ©ã‚°ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒ‡å®šã§ãã¾ã™ãŒã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®ã¿æŒ‡å®šå¯èƒ½
- Cloud Buildã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ`@cloudbuild.gserviceaccount.com`ï¼‰ã¯æŒ‡å®šã§ããªã„
- ãƒ•ãƒ©ã‚°ã‚’æŒ‡å®šã—ãªã„å ´åˆã€Compute Engineãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½¿ç”¨ã•ã‚Œã‚‹

### 2. æ¨©é™ã®åæ˜ æ™‚é–“

- IAMãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´ã¯å³åº§ã«åæ˜ ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹
- æœ€å¤§10-15åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹
- ã‚¨ãƒ©ãƒ¼ãŒç¶šãå ´åˆã¯ã€æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ

### 3. ãƒªãƒã‚¸ãƒˆãƒªã®è‡ªå‹•ä½œæˆ

- `gcloud run deploy --source`ã¯`cloud-run-source-deploy`ãƒªãƒã‚¸ãƒˆãƒªã‚’è‡ªå‹•ä½œæˆã™ã‚‹
- ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ« vs ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®æ¨©é™ã ã‘ã§ã¯ä¸ååˆ†ãªå ´åˆãŒã‚ã‚‹
- ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™ã‚‚æ˜ç¤ºçš„ã«ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ç‰¹ã«`roles/artifactregistry.admin`ã‚’ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã§ä»˜ä¸ã™ã‚‹ã“ã¨ãŒé‡è¦

## ğŸ“Š ç¾åœ¨ã®è¨­å®šçŠ¶æ³

### æ¨©é™è¨­å®šã®ç¢ºèª

```bash
PROJECT_NUMBER=$(gcloud projects describe ai-chat-481005 --format="value(projectNumber)")

# Compute Engineã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™
echo "=== Compute Engineã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ==="
gcloud projects get-iam-policy ai-chat-481005 \
  --flatten="bindings[].members" \
  --format="table(bindings.role)" \
  --filter="bindings.members:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"

# ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®æ¨©é™
echo "=== ai-chatãƒªãƒã‚¸ãƒˆãƒª ==="
gcloud artifacts repositories get-iam-policy ai-chat \
  --location=asia-northeast1 \
  --project=ai-chat-481005
```

## ğŸ”— é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

- **Cloud Runã‚³ãƒ³ã‚½ãƒ¼ãƒ«**: https://console.cloud.google.com/run/detail/asia-northeast1/ai-chat?project=ai-chat-481005
- **Cloud Buildã‚³ãƒ³ã‚½ãƒ¼ãƒ«**: https://console.cloud.google.com/cloud-build/builds?project=ai-chat-481005
- **Artifact Registryã‚³ãƒ³ã‚½ãƒ¼ãƒ«**: https://console.cloud.google.com/artifacts?project=ai-chat-481005
- **GitHub Actions**: https://github.com/Yoshihiro-Kameoka/ai-chat/actions

## ğŸ“š å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DEPLOY.md](./DEPLOY.md) - è©³ç´°ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
- [README.md](./README.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [Google Cloud Run ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/run/docs)
- [Workload Identity Federation ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/iam/docs/workload-identity-federation)

## ğŸ†˜ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š
1. ä¸Šè¨˜ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
2. Cloud Buildã®ãƒ­ã‚°ã‚’ç¢ºèª
3. IAMãƒãƒªã‚·ãƒ¼ã‚’å†ç¢ºèª
4. å¿…è¦ã«å¿œã˜ã¦æ¨©é™ã‚’å†è¨­å®š

---

**æœ€çµ‚æ›´æ–°**: 2025-12-17
**ä½œæˆè€…**: AI Assistant
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: AI Chat (ai-chat-481005)

