# ğŸ”„ GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è§£èª¬

> CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹æˆã¨å¤‰æ›´å±¥æ­´ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™

## ğŸ“ å¤‰æ›´ã®æ¦‚è¦

Google Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’ã€**Cloud BuildçµŒç”±ã®ãƒ“ãƒ«ãƒ‰**ã‹ã‚‰**GitHub Actionsä¸Šã§ã®ç›´æ¥Dockerãƒ“ãƒ«ãƒ‰**ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

---

## ğŸ”„ å¤‰æ›´ã®èƒŒæ™¯

### ä»¥å‰ã®æ–¹æ³•ã§ç™ºç”Ÿã—ã¦ã„ãŸå•é¡Œ

`gcloud run deploy --source .` ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç¹°ã‚Šè¿”ã—ç™ºç”Ÿï¼š

```
ERROR: denied: Permission "artifactregistry.repositories.uploadArtifacts" denied on resource 
"projects/ai-chat-481005/locations/asia-northeast1/repositories/ai-chat" (or it may not exist)
```

### å•é¡Œã®æ ¹æœ¬åŸå› 

1. **è¤‡é›‘ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ§‹æˆ**
   - `gcloud run deploy --source` ã¯å†…éƒ¨çš„ã«Cloud Buildã‚’ä½¿ç”¨
   - Cloud Buildã¯è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆCompute Engineã€Cloud Buildã€Cloud Build Service Agentï¼‰
   - ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã©ã®æ“ä½œã‚’è¡Œã†ã‹ãŒä¸é€æ˜

2. **æ¨©é™è¨­å®šã®è¤‡é›‘ã•**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã¨ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ã®ä¸¡æ–¹ã«æ¨©é™ãŒå¿…è¦
   - è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã™ã¹ã¦ã«é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦
   - IAMãƒãƒªã‚·ãƒ¼ã®åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹ï¼ˆæœ€å¤§10-15åˆ†ï¼‰

3. **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å›°é›£ã•**
   - ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å¤±æ•—ã—ã¦ã„ã‚‹ã‹ç‰¹å®šãŒå›°é›£
   - Cloud Buildã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ›–æ˜§

---

## âœ¨ æ–°ã—ã„æ–¹æ³•ã®åˆ©ç‚¹

### 1. ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨©é™æ§‹æˆ

ã™ã¹ã¦ã®æ“ä½œãŒ**å˜ä¸€ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼ˆ`github-actions-deploy`ï¼‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
GitHub Actions
  â†“ (Workload Identity Federation)
github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com
  â†“
1. Dockerãƒ“ãƒ«ãƒ‰ï¼ˆGitHub Actionsãƒ©ãƒ³ãƒŠãƒ¼ä¸Šï¼‰
2. ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆArtifact Registryï¼‰
3. Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
```

### 2. é€æ˜æ€§ã®å‘ä¸Š

å„ã‚¹ãƒ†ãƒƒãƒ—ãŒæ˜ç¤ºçš„ã§ã€ä½•ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹æ˜ç¢ºï¼š

```yaml
- Dockerèªè¨¼
- Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
- ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
- Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
```

### 3. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®¹æ˜“ã•

- ã‚¨ãƒ©ãƒ¼ãŒã©ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç™ºç”Ÿã—ãŸã‹å³åº§ã«åˆ¤æ˜
- GitHub Actionsã®ãƒ­ã‚°ã§ç›´æ¥ç¢ºèªå¯èƒ½
- Cloud Buildã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒãªã„

---

## ğŸ“Š å¤‰æ›´ç‚¹ã®è©³ç´°æ¯”è¼ƒ

### ä»¥å‰ã®æ–¹æ³•ï¼ˆCloud BuildçµŒç”±ï¼‰

```yaml
- name: Deploy to Cloud Run
  run: |
    # Cloud Buildã«è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã•ã›ã‚‹
    # ï¼ˆCompute Engineãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½¿ç”¨ã•ã‚Œã€æ¨©é™ã¯è¨­å®šæ¸ˆã¿ï¼‰
    gcloud run deploy ai-chat \
      --source . \                    # â† ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰
      --platform managed \
      --region asia-northeast1 \
      --allow-unauthenticated \
      --memory 512Mi \
      --cpu 1 \
      --max-instances 10 \
      --min-instances 0 \
      --set-env-vars "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" \
      --project=ai-chat-481005
```

**å•é¡Œç‚¹:**
- âŒ Cloud BuildãŒå†…éƒ¨çš„ã«èµ·å‹•ã•ã‚Œã‚‹
- âŒ è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé–¢ä¸
- âŒ æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒé »ç™º
- âŒ ã‚¨ãƒ©ãƒ¼ã®ç‰¹å®šãŒå›°é›£

---

### ç¾åœ¨ã®æ–¹æ³•ï¼ˆç›´æ¥Dockerãƒ“ãƒ«ãƒ‰ï¼‰

```yaml
# ã‚¹ãƒ†ãƒƒãƒ—1: Dockerèªè¨¼
- name: Configure Docker to use gcloud as credential helper
  run: |
    gcloud auth configure-docker asia-northeast1-docker.pkg.dev

# ã‚¹ãƒ†ãƒƒãƒ—2: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
- name: Build Docker image
  run: |
    docker build -t asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} .
    docker tag asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} \
               asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:latest

# ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
- name: Push Docker image to Artifact Registry
  run: |
    docker push asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }}
    docker push asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:latest

# ã‚¹ãƒ†ãƒƒãƒ—4: Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
- name: Deploy to Cloud Run
  run: |
    gcloud run deploy ai-chat \
      --image asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} \  # â† ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®š
      --platform managed \
      --region asia-northeast1 \
      --allow-unauthenticated \
      --memory 512Mi \
      --cpu 1 \
      --max-instances 10 \
      --min-instances 0 \
      --set-env-vars "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" \
      --project=ai-chat-481005
```

**åˆ©ç‚¹:**
- âœ… ã™ã¹ã¦ãŒ1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å®Ÿè¡Œ
- âœ… å„ã‚¹ãƒ†ãƒƒãƒ—ãŒæ˜ç¤ºçš„
- âœ… ã‚¨ãƒ©ãƒ¼ã®ç‰¹å®šãŒå®¹æ˜“
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚åŒã˜æ‰‹é †ã§å†ç¾å¯èƒ½

---

## ğŸ”§ å„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°è§£èª¬

### ã‚¹ãƒ†ãƒƒãƒ—1: Dockerèªè¨¼

```yaml
- name: Configure Docker to use gcloud as credential helper
  run: |
    gcloud auth configure-docker asia-northeast1-docker.pkg.dev
```

**ç›®çš„:**
- Dockerã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®šã—ã€Artifact Registryã¸ã®èªè¨¼ã‚’æœ‰åŠ¹åŒ–

**å‹•ä½œ:**
- `~/.docker/config.json` ã«èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’è¿½åŠ 
- `gcloud` ãŒèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•çš„ã«æä¾›

**ä½¿ç”¨ã•ã‚Œã‚‹æ¨©é™:**
- `roles/artifactregistry.writer`ï¼ˆGitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰

---

### ã‚¹ãƒ†ãƒƒãƒ—2: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰

```yaml
- name: Build Docker image
  run: |
    docker build -t asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} .
    docker tag asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} \
               asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:latest
```

**ç›®çš„:**
- `Dockerfile` ã‹ã‚‰Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
- ã‚³ãƒŸãƒƒãƒˆSHAã¨latestã®ä¸¡æ–¹ã®ã‚¿ã‚°ã‚’ä»˜ä¸

**ã‚¤ãƒ¡ãƒ¼ã‚¸åã®æ§‹é€ :**
```
asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:COMMIT_SHA
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜
         ãƒªãƒ¼ã‚¸ãƒ§ãƒ³     ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID  ãƒªãƒã‚¸ãƒˆãƒª ã‚¤ãƒ¡ãƒ¼ã‚¸å  ã‚¿ã‚°
```

**ã‚¿ã‚°æˆ¦ç•¥:**
- `${{ github.sha }}`: ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆã«ç´ä»˜ã„ãŸä¸å¤‰ã®ã‚¿ã‚°
- `latest`: å¸¸ã«æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æŒ‡ã™

**ãƒ“ãƒ«ãƒ‰å ´æ‰€:**
- GitHub Actionsãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆUbuntuï¼‰ä¸Šã§å®Ÿè¡Œ
- Cloud Buildã¯ä½¿ç”¨ã—ãªã„

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥

```yaml
- name: Push Docker image to Artifact Registry
  run: |
    docker push asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }}
    docker push asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:latest
```

**ç›®çš„:**
- ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Artifact Registryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**å‹•ä½œ:**
- Docker CLIãŒ `gcloud` ã®èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨
- 2ã¤ã®ã‚¿ã‚°ï¼ˆSHAã€latestï¼‰ã‚’ä¸¡æ–¹ãƒ—ãƒƒã‚·ãƒ¥

**ä½¿ç”¨ã•ã‚Œã‚‹æ¨©é™:**
- `roles/artifactregistry.writer`ï¼ˆãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ï¼‰

**ãƒ—ãƒƒã‚·ãƒ¥å…ˆ:**
- ãƒªãƒã‚¸ãƒˆãƒª: `ai-chat`
- ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: `asia-northeast1`
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: `ai-chat-481005`

---

### ã‚¹ãƒ†ãƒƒãƒ—4: Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤

```yaml
- name: Deploy to Cloud Run
  run: |
    gcloud run deploy ai-chat \
      --image asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:${{ github.sha }} \
      --platform managed \
      --region asia-northeast1 \
      --allow-unauthenticated \
      --memory 512Mi \
      --cpu 1 \
      --max-instances 10 \
      --min-instances 0 \
      --set-env-vars "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" \
      --project=ai-chat-481005
```

**ç›®çš„:**
- ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

**é‡è¦ãªå¤‰æ›´:**
- `--source .` â†’ `--image <IMAGE_URL>` ã«å¤‰æ›´
- Cloud Buildã‚’ä½¿ç”¨ã—ãªã„
- æ—¢ã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®š

**ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š:**
- ãƒ¡ãƒ¢ãƒª: 512Mi
- CPU: 1
- æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: 0ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
- æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: 10ï¼ˆè‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
- èªè¨¼: ä¸è¦ï¼ˆ`--allow-unauthenticated`ï¼‰

**ä½¿ç”¨ã•ã‚Œã‚‹æ¨©é™:**
- `roles/run.admin`ï¼ˆCloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ç®¡ç†ï¼‰

---

## ğŸ” å¿…è¦ãªæ¨©é™

### GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¿…è¦ãªæ¨©é™

```bash
SERVICE_ACCOUNT="github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com"
```

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«
```bash
# Cloud Runç®¡ç†
roles/run.admin

# Artifact Registryæ›¸ãè¾¼ã¿
roles/artifactregistry.writer

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
roles/iam.serviceAccountUser

# APIã®æœ‰åŠ¹åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
roles/serviceusage.serviceUsageAdmin

# Storageç®¡ç†ï¼ˆã‚½ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
roles/storage.admin
```

#### ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«ï¼ˆai-chatï¼‰
```bash
# Artifact Registryæ›¸ãè¾¼ã¿
roles/artifactregistry.writer
```

### æ¨©é™è¨­å®šã‚³ãƒãƒ³ãƒ‰

```bash
PROJECT_ID="ai-chat-481005"
SA="github-actions-deploy@${PROJECT_ID}.iam.gserviceaccount.com"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${SA}" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${SA}" \
  --role="roles/artifactregistry.writer"

# ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ãƒ™ãƒ«
gcloud artifacts repositories add-iam-policy-binding ai-chat \
  --location=asia-northeast1 \
  --member="serviceAccount:${SA}" \
  --role="roles/artifactregistry.writer" \
  --project=${PROJECT_ID}
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã®å…¨ä½“åƒ

### 1. ãƒˆãƒªã‚¬ãƒ¼
```
git push origin main
  â†“
GitHub Actionsèµ·å‹•
```

### 2. æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—
```
1. ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
2. gcloud SDK ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
3. Workload Identity Federationã§èªè¨¼
4. å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–
```

### 3. ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—
```
5. Dockerèªè¨¼è¨­å®š
   â†“
6. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆGitHub Actionsä¸Šï¼‰
   â†“
7. Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥
   â†“
8. Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
   â†“
9. ã‚µãƒ¼ãƒ“ã‚¹URLã‚’å–å¾—ãƒ»å‡ºåŠ›
```

### 4. æ‰€è¦æ™‚é–“ï¼ˆç›®å®‰ï¼‰
- æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—: ç´„1åˆ†
- Dockerãƒ“ãƒ«ãƒ‰: ç´„3-5åˆ†
- ãƒ—ãƒƒã‚·ãƒ¥: ç´„1-2åˆ†
- ãƒ‡ãƒ—ãƒ­ã‚¤: ç´„1-2åˆ†
- **åˆè¨ˆ: ç´„6-10åˆ†**

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: Dockerèªè¨¼å¤±æ•—

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
Error response from daemon: Get https://asia-northeast1-docker.pkg.dev/v2/: unauthorized
```

**åŸå› :**
- `gcloud auth configure-docker` ãŒå¤±æ•—
- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹

**è§£æ±ºæ–¹æ³•:**
1. Workload Identity Federationã®è¨­å®šã‚’ç¢ºèª
2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã‚’ç¢ºèª
3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ

---

### ã‚¨ãƒ©ãƒ¼2: ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
denied: Permission "artifactregistry.repositories.uploadArtifacts" denied
```

**åŸå› :**
- GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«`roles/artifactregistry.writer`ãŒä¸è¶³

**è§£æ±ºæ–¹æ³•:**
```bash
gcloud artifacts repositories add-iam-policy-binding ai-chat \
  --location=asia-northeast1 \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer" \
  --project=ai-chat-481005
```

---

### ã‚¨ãƒ©ãƒ¼3: Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ERROR: (gcloud.run.deploy) PERMISSION_DENIED: Permission 'run.services.get' denied
```

**åŸå› :**
- GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«`roles/run.admin`ãŒä¸è¶³

**è§£æ±ºæ–¹æ³•:**
```bash
gcloud projects add-iam-policy-binding ai-chat-481005 \
  --member="serviceAccount:github-actions-deploy@ai-chat-481005.iam.gserviceaccount.com" \
  --role="roles/run.admin"
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

### ä»¥å‰ã®æ–¹æ³•ï¼ˆCloud BuildçµŒç”±ï¼‰
- âœ… Cloud Buildã®æœ€é©åŒ–ã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ç’°å¢ƒ
- âŒ ã‚½ãƒ¼ã‚¹ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚é–“ãŒå¿…è¦
- âŒ Cloud Buildã®èµ·å‹•æ™‚é–“ãŒå¿…è¦
- âŒ è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–“ã®é€£æºã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

### ç¾åœ¨ã®æ–¹æ³•ï¼ˆç›´æ¥ãƒ“ãƒ«ãƒ‰ï¼‰
- âœ… GitHub Actionsãƒ©ãƒ³ãƒŠãƒ¼ã®é«˜é€Ÿãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
- âœ… ä¸­é–“ã‚¹ãƒ†ãƒƒãƒ—ã®å‰Šæ¸›
- âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨ãŒå®¹æ˜“
- âŒ GitHub Actionsãƒ©ãƒ³ãƒŠãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™

**å®Ÿæ¸¬:**
- ä»¥å‰: ç´„8-12åˆ†ï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ã®å ´åˆï¼‰
- ç¾åœ¨: ç´„6-10åˆ†

---

## ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å†ç¾æ–¹æ³•

æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚åŒã˜æ‰‹é †ã§å†ç¾å¯èƒ½ã§ã™ï¼š

```bash
# 1. èªè¨¼
gcloud auth login
gcloud auth configure-docker asia-northeast1-docker.pkg.dev

# 2. ãƒ“ãƒ«ãƒ‰
docker build -t asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:local .

# 3. ãƒ—ãƒƒã‚·ãƒ¥
docker push asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:local

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy ai-chat \
  --image asia-northeast1-docker.pkg.dev/ai-chat-481005/ai-chat/ai-chat:local \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --memory 512Mi \
  --cpu 1 \
  --set-env-vars "ANTHROPIC_API_KEY=your-key-here" \
  --project=ai-chat-481005
```

---

## ğŸ“š å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

- [Google Cloud Run ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/run/docs)
- [Artifact Registry ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/artifact-registry/docs)
- [Workload Identity Federation](https://cloud.google.com/iam/docs/workload-identity-federation)
- [GitHub Actions - Docker](https://docs.github.com/en/actions/publishing-packages/publishing-docker-images)

---

## ğŸ“ ã¾ã¨ã‚

### å¤‰æ›´ã®æœ¬è³ª

**ä»¥å‰**: Cloud Buildã«ä¾å­˜ã—ãŸè¤‡é›‘ãªæ§‹æˆ
```
GitHub Actions â†’ Cloud Build â†’ Artifact Registry â†’ Cloud Run
```

**ç¾åœ¨**: ã‚·ãƒ³ãƒ—ãƒ«ã§é€æ˜æ€§ã®é«˜ã„æ§‹æˆ
```
GitHub Actions â†’ Artifact Registry â†’ Cloud Run
```

### ä¸»è¦ãªãƒ¡ãƒªãƒƒãƒˆ

1. âœ… **ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨©é™ç®¡ç†**: å˜ä¸€ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
2. âœ… **é€æ˜æ€§ã®å‘ä¸Š**: å„ã‚¹ãƒ†ãƒƒãƒ—ãŒæ˜ç¤ºçš„
3. âœ… **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®¹æ˜“ã•**: ã‚¨ãƒ©ãƒ¼ã®ç‰¹å®šãŒç°¡å˜
4. âœ… **ãƒ­ãƒ¼ã‚«ãƒ«å†ç¾æ€§**: åŒã˜æ‰‹é †ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚å®Ÿè¡Œå¯èƒ½
5. âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š**: ä¸­é–“ã‚¹ãƒ†ãƒƒãƒ—ã®å‰Šæ¸›

### ã“ã®å¤‰æ›´ã‚’æ¨å¥¨ã™ã‚‹ç†ç”±

- ğŸ¯ æ¨©é™ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬çš„ãªè§£æ±º
- ğŸ¯ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã®å‘ä¸Š
- ğŸ¯ ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“ã•
- ğŸ¯ å°†æ¥çš„ãªæ‹¡å¼µæ€§

---

**æœ€çµ‚æ›´æ–°**: 2025-12-17  
**ä½œæˆè€…**: AI Assistant  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: AI Chat (ai-chat-481005)

